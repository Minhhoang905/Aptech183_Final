<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gi·ªè h√†ng</title>
	<link rel="stylesheet" href="/styles.css">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>


<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
        <div class="container-fluid">
            <!-- G√≥c tr√°i: Icon -->
            <a class="navbar-brand" href="#">
                <i class="fas fa-dumbbell"></i>
            </a>

            <!-- Button toggle menu cho mobile -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <!-- Navbar -->
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" th:href="@{/ComplexGym/home}">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="bookingLink" role="button">
                            Schedule
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="productsDropdown" role="button"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            Products
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="productsDropdown">
                            <li><a class="dropdown-item" th:href="@{/ComplexGym/products/supplements}">Supplement</a></li>
                            <li><a class="dropdown-item" th:href="@{/ComplexGym/products/gears}">Gears</a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/ComplexGym/cart}">
                            <i class="fas fa-shopping-cart"></i> Cart <span id="cart-count"></span>
                        </a>
                    </li>
                </ul>

                <!-- Hi·ªÉn th·ªã theo tr·∫°ng th√°i ƒëƒÉng nh·∫≠p -->
                <div class="ms-3">
                    <th:block th:if="${role == 'Anonymous'}">
                        <a class="btn btn-warning" th:href="@{/login}">Login</a>
                    </th:block>
                    <th:block th:if="${role != 'Anonymous'}">
                        <div class="dropdown">
                            <button class="btn btn-warning dropdown-toggle" type="button" id="userMenu"
                                data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-user"></i> <span th:text="${username}"></span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenu">
                                <li th:if="${role == 'ROLE_ADMIN'}"><a class="dropdown-item" th:href="@{/userManagement}">User Management</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li th:if="${role == 'ROLE_ADMIN'}"><a class="dropdown-item" th:href="@{/ComplexGym/products/productManagement}">Product Management</a></li>
                                <li><hr class="dropdown-divider"></li>                                
                                <li><a class="dropdown-item logout-item" th:href="@{/logout}">Logout</a></li>
                            </ul>
                        </div>
                    </th:block>
                </div>
            </div>
        </div>
    </nav>

	<div class="row">
	    <!-- Danh s√°ch s·∫£n ph·∫©m trong gi·ªè h√†ng -->
	    <div class="col-md-8">
	        <div class="row" th:if="${cartItems != null and not #lists.isEmpty(cartItems)}">
	            <div th:each="cart : ${cartItems}" class="col-md-6 mb-3">
	                <div class="card shadow-sm">
	                    <!-- Hi·ªÉn th·ªã ·∫£nh s·∫£n ph·∫©m -->
	                    <img th:src="${cart.imagePath}" class="card-img-top" 
	                         alt="Product Image" style="height: 200px; object-fit: cover;">
	                    <div class="card-body">
	                        <!-- Hi·ªÉn th·ªã t√™n s·∫£n ph·∫©m -->
	                        <h5 class="card-title" th:text="${cart.productName}"></h5>
	                        
	                        <!-- Hi·ªÉn th·ªã gi√° s·∫£n ph·∫©m -->
	                        <p class="text-danger fw-bold">Price: 
	                            <span th:text="${#numbers.formatInteger(cart.price, 3, 'POINT')}"></span>  VND
	                        </p>
	
	                        <!-- Hi·ªÉn th·ªã s·ªë l∆∞·ª£ng s·∫£n ph·∫©m -->
	                        <div class="d-flex align-items-center">
	                            <!-- N√∫t gi·∫£m s·ªë l∆∞·ª£ng -->
	                            <button class="btn btn-outline-secondary btn-sm decrease-btn"
	                                    th:data-cart-id="${cart.id}"
	                                    th:data-max-quantity="${cart.quantity}">‚ûñ</button>
	
	                            <!-- Input hi·ªÉn th·ªã s·ªë l∆∞·ª£ng -->
	                            <input type="number" class="form-control text-center mx-2 quantity-input"
	                                   th:value="${cart.amount}" min="1"
	                                   th:data-product-id="${cart.id}"
	                                   style="width: 60px;" readonly>
	
	                            <!-- N√∫t tƒÉng s·ªë l∆∞·ª£ng -->
	                            <button class="btn btn-outline-secondary btn-sm increase-btn"
	                                    th:data-cart-id="${cart.id}"
	                                    th:data-max-quantity="${cart.quantity}">‚ûï</button>
	                        </div>
	
	                        <!-- Hi·ªÉn th·ªã c·∫£nh b√°o n·∫øu s·ªë l∆∞·ª£ng v∆∞·ª£t qu√° t·ªìn kho -->
	                        <p class="text-danger small mt-2 d-none warning-text"
	                           th:id="'warning-' + ${cart.id}">
	                           ‚ö† The quantity of products in stock is insufficient!
	                        </p>
	
	                        <!-- Form x√≥a s·∫£n ph·∫©m kh·ªèi gi·ªè h√†ng -->
	                        <form th:action="@{/ComplexGym/cart/delete}" method="post" class="mt-2">
	                            <input type="hidden" name="cartId" th:value="${cart.id}">
	                            <button type="submit" class="btn btn-danger"
	                                    onclick="return confirm('Are you sure you want to remove this product from your cart?');">
	                                Delete
	                            </button>
	                        </form>
	                    </div>
	                </div>
	            </div>
	        </div>
	
	        <!-- Hi·ªÉn th·ªã th√¥ng b√°o n·∫øu gi·ªè h√†ng tr·ªëng -->
	        <div th:if="${cartItems == null or #lists.isEmpty(cartItems)}" class="text-center">
	            <h4 class="text-muted">Your cart is empty now üò¢</h4>
	            <a onclick="history.back()" class="btn btn-primary mt-3">üîô Back to the previous page</a>
	        </div>
	    </div>
	
	    <!-- C·ªôt b√™n ph·∫£i: T·ªïng ti·ªÅn v√† n√∫t Thanh to√°n -->
	    <div class="col-md-4">
	        <div class="card p-3 shadow">
	            <h4 class="fw-bold text-center">Total</h4>
				<p class="fw-bold text-center text-danger fs-5">
				    <span id="totalAmount">
				        <th:block th:if="${totalAmount != null}" 
				                  th:text="${#numbers.formatInteger(totalAmount, 3, 'POINT')}"></th:block> VND
				    </span>
				</p>
	
	            <!-- Form chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang thanh to√°n -->
	            <form th:action="@{/ComplexGym/payment}" method="get">
	                <button type="submit" class="btn btn-success w-100"
	                        th:disabled="${cartItems == null or #lists.isEmpty(cartItems)}">
	                    üí≥ Go to payment
	                </button>
	            </form>
	        </div>
	    </div>
	</div>
	<!-- Script c·ªßa Bootstrap -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
	
	<!-- JavaScript ƒë·ªÉ x·ª≠ l√Ω c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng -->
	<script>
	document.querySelectorAll(".increase-btn").forEach(button => {
	    button.addEventListener("click", function() {
	        let cartId = this.getAttribute("data-cart-id");
	        changeAmount(1, cartId); // ‚úÖ TƒÉng s·ªë l∆∞·ª£ng
	    });
	});

	document.querySelectorAll(".decrease-btn").forEach(button => {
	    button.addEventListener("click", function() {
	        let cartId = this.getAttribute("data-cart-id");
	        changeAmount(-1, cartId); // ‚úÖ Gi·∫£m s·ªë l∆∞·ª£ng
	    });
	});

	// ‚úÖ C·∫≠p nh·∫≠t t·ªïng s·ªë ti·ªÅn tr√™n giao di·ªán
	function updateTotalAmount(amount) {
	    document.getElementById("totalAmount").textContent =
	        new Intl.NumberFormat("vi-VN").format(amount) + " VND"; // ƒê·ªãnh d·∫°ng ti·ªÅn t·ªá VNƒê
	}

	// ‚úÖ X·ª≠ l√Ω c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng s·∫£n ph·∫©m trong gi·ªè h√†ng
	function updateCart(cartId, newAmount) {
	    if (newAmount < 1) {
	        removeCartItem(cartId);
	        return;
	    }
	
	    fetch("/ComplexGym/cart/update", {
	        method: "POST",
	        headers: { "Content-Type": "application/x-www-form-urlencoded" },
	        body: `cartId=${cartId}&amount=${newAmount}`
	    })
	    .then(response => response.text()) // Nh·∫≠n d·ªØ li·ªáu t·ª´ server
	    .then(data => {
	        console.log("Server response:", data);

	        let [updatedAmount, totalAmount] = data.split("|"); // ‚úÖ T√°ch d·ªØ li·ªáu t·ª´ server
	        updatedAmount = parseInt(updatedAmount);
	        totalAmount = parseFloat(totalAmount);

	        let inputField = document.querySelector(`input[data-product-id="${cartId}"]`);
	        if (inputField) inputField.value = updatedAmount; // ‚úÖ C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng m·ªõi tr√™n giao di·ªán

	        if (!isNaN(totalAmount)) {
	            updateTotalAmount(totalAmount); // ‚úÖ C·∫≠p nh·∫≠t t·ªïng ti·ªÅn tr√™n giao di·ªán
	        }
	    })
	    .catch(error => console.error("Error updating cart:", error));
	}

	// ‚úÖ T·ª± ƒë·ªông t√≠nh t·ªïng ti·ªÅn d·ª±a tr√™n s·ªë l∆∞·ª£ng s·∫£n ph·∫©m hi·ªÉn th·ªã (ph√≤ng khi API b·ªã l·ªói)
	function calculateTotal() {
	    let total = 0;
	
	    // L·∫∑p qua t·ª´ng s·∫£n ph·∫©m trong gi·ªè h√†ng
	    document.querySelectorAll(".quantity-input").forEach(input => {
	        let quantity = parseInt(input.value); // L·∫•y s·ªë l∆∞·ª£ng s·∫£n ph·∫©m
	        if (isNaN(quantity) || quantity < 1) return; // N·∫øu s·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá, b·ªè qua
	
	        let priceElement = input.closest(".card-body").querySelector(".text-danger span");
	        let priceText = priceElement ? priceElement.textContent.replace(/\./g, "") : "0"; // L·∫•y gi√° s·∫£n ph·∫©m, b·ªè d·∫•u ch·∫•m ph√¢n c√°ch h√†ng ngh√¨n
	        let price = parseFloat(priceText); // ƒê·∫£m b·∫£o gi√° l√† s·ªë
	
	        if (isNaN(price) || price <= 0) return; // N·∫øu gi√° kh√¥ng h·ª£p l·ªá, b·ªè qua
	
	        total += quantity * price; // T√≠nh t·ªïng ti·ªÅn
	    });
	
	    updateTotalAmount(total); // C·∫≠p nh·∫≠t t·ªïng ti·ªÅn tr√™n giao di·ªán
	}

	// ‚úÖ X·ª≠ l√Ω s·ª± ki·ªán tƒÉng / gi·∫£m s·ªë l∆∞·ª£ng s·∫£n ph·∫©m khi nh·∫•n n√∫t `+` ho·∫∑c `-`
	function changeAmount(delta, cartId) {
	    let inputField = document.querySelector(`input[data-product-id="${cartId}"]`);
	    if (!inputField) return; // N·∫øu kh√¥ng t√¨m th·∫•y input, tho√°t h√†m

	    let currentAmount = parseInt(inputField.value); // L·∫•y s·ªë l∆∞·ª£ng hi·ªán t·∫°i
	    let newAmount = currentAmount + delta; // C·ªông ho·∫∑c tr·ª´ s·ªë l∆∞·ª£ng

	    if (newAmount < 1) return; // Kh√¥ng cho ph√©p s·ªë l∆∞·ª£ng < 1

	    updateCart(cartId, newAmount); // G·ªçi h√†m c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng
	}

	// ‚úÖ X√≥a s·∫£n ph·∫©m kh·ªèi gi·ªè h√†ng
	function removeCartItem(cartId) {
	    fetch(`/ComplexGym/cart/delete?cartId=${cartId}`, {
	        method: "POST"
	    })
	    .then(response => response.json()) // Nh·∫≠n ph·∫£n h·ªìi JSON t·ª´ server
	    .then(data => {
	        if (data.success) {
	            document.getElementById(`cart-row-${cartId}`).remove(); // X√≥a s·∫£n ph·∫©m kh·ªèi giao di·ªán
	            calculateTotal(); // C·∫≠p nh·∫≠t t·ªïng ti·ªÅn sau khi x√≥a s·∫£n ph·∫©m
	        } else {
	            alert("‚ùå Error: Unable to remove product from cart.");
	        }
	    })
	    .catch(error => {
	        console.error("Error removing cart item:", error);
	    });
	}
	
	document.addEventListener("DOMContentLoaded", function () {
	    calculateTotal(); // T√≠nh t·ªïng ti·ªÅn ngay khi trang ƒë∆∞·ª£c load
	});

	</script>
    
</body>

</html>