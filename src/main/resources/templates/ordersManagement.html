<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orders management</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">
</head>

<body>

<div class="container mt-4">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
        <div class="container-fluid">
            <!-- G√≥c tr√°i: Icon -->
            <a class="navbar-brand" href="#">
                <i class="fas fa-dumbbell"></i>
            </a>

            <!-- Button toggle menu cho mobile -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <!-- Navbar -->
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" th:href="@{/ComplexGym/home}">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="bookingLink" role="button">
                            Schedule
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="productsDropdown" role="button"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            Products
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="productsDropdown">
                            <li><a class="dropdown-item" th:href="@{/ComplexGym/products/supplements}">Supplement</a></li>
                            <li><a class="dropdown-item" th:href="@{/ComplexGym/products/gears}">Gears</a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/ComplexGym/cart}">
                            <i class="fas fa-shopping-cart"></i> Cart <span id="cart-count"></span>
                        </a>
                    </li>
                </ul>

                <!-- Hi·ªÉn th·ªã theo tr·∫°ng th√°i ƒëƒÉng nh·∫≠p -->
                <div class="ms-3">
                    <th:block th:if="${role == 'Anonymous'}">
                        <a class="btn btn-warning" th:href="@{/login}">Login</a>
                    </th:block>
                    <th:block th:if="${role != 'Anonymous'}">
                        <div class="dropdown">
                            <button class="btn btn-warning dropdown-toggle" type="button" id="userMenu"
                                data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-user"></i> <span th:text="${username}"></span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenu">
                                <li th:if="${role == 'ROLE_ADMIN'}"><a class="dropdown-item" th:href="@{/userManagement}">User Management</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li th:if="${role == 'ROLE_ADMIN'}"><a class="dropdown-item" th:href="@{/ComplexGym/products/productManagement}">Product Management</a></li>
                                <li><hr class="dropdown-divider"></li>
                        		<li><a th:href="@{/ComplexGym/products/ordersManagement}">Order<br>management</a></li>
                                <li><hr class="dropdown-divider"></li>                                
                                                                
                                <li><a class="dropdown-item logout-item" th:href="@{/logout}">Logout</a></li>
                            </ul>
                        </div>
                    </th:block>
                </div>
            </div>
        </div>
    </nav>
</div>

<h2>üì¶ Danh s√°ch ƒë∆°n h√†ng</h2>
<!-- Hi·ªÉn th·ªã th√¥ng b√°o flash -->
<div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
<div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>
    
<table class="table table-bordered" >
    <thead>
        <tr>
			<!-- M√£ ƒë∆°n -->
			<th>Order ID</th>
			<!-- Ng√†y ƒë·∫∑t -->
			<th>Order Date</th>
			<!-- Th·ªùi gian k·∫øt th√∫c -->
			<th>End Time</th>
			<!-- Tr·∫°ng th√°i -->
			<th>Status</th>
			<!-- T√™n ng∆∞·ªùi d√πng --> 
			<th>User Name</th> 
			<!-- H·ªç t√™n ng∆∞·ªùi nh·∫≠n -->
			<th>Recipient Name</th> 
			<!-- S·ªë ƒëi·ªán tho·∫°i -->
			<th>Phone Number</th> 
			<!-- Email -->
			<th>Email</th> 
			<!-- T√™n t·ªânh -->
			<th>Province</th> 
			<!-- T√™n qu·∫≠n -->
			<th>District</th> 
			<!-- T√™n x√£ -->
			<th>Ward</th>
			<!-- ƒê·ªãa ch·ªâ giao h√†ng -->
			<th>Delivery Address</th>             
			<!-- Ph∆∞∆°ng th·ª©c thanh to√°n -->
			<th>Payment Method</th> 
			<!-- Ghi ch√∫ -->
			<th>Notes</th> 
			<!-- T·ªïng ti·ªÅn -->
			<th>Total Amount</th> 
			<!-- Chi ti·∫øt ƒë∆°n h√†ng -->
			<th>Order Details</th>
        </tr>
    </thead>
    <th:block th:each="order : ${orders}">
        <tr>
        	<!-- M√£ ƒë∆°n -->
            <td th:text="${order.orderId}"></td>
            <!-- Ng√†y ƒë·∫∑t -->
            <td th:text="${#temporals.format(order.orderStartTime, 'dd/MM/yyyy HH:mm')}"></td>
            <!-- Th·ªùi gian k·∫øt th√∫c -->
            <td th:text="${#temporals.format(order.orderEndTime, 'dd/MM/yyyy HH:mm')}"></td>
			<!-- Tr·∫°ng th√°i ƒë∆°n h√†ng -->
			<td>
			    <span th:text="${order.orderStatus}"></span>
			    <div style="margin-top: 5px;">
			        <form th:action="@{/ComplexGym/payment/updateOrderStatus}" method="post" class="order-status-form d-flex align-items-center gap-2 mt-1">
			            <!-- Th√™m tr∆∞·ªùng ·∫©n ƒë·ªÉ hi·ªÉn th·ªã orderId -->
			            <input type="hidden" name="orderId" th:value="${order.orderId}" />
			            <!-- Hi·ªÉn th·ªã tr·∫°ng th√°i 'CANCEL' n·∫øu orderStatus l√† CANCEL v√† ·∫©n dropdown -->
			            <div th:if="${order.orderStatus == 'CANCEL'}">
			                <span class="badge bg-danger">CANCEL</span>
			                <!-- N√∫t Delete khi tr·∫°ng th√°i l√† CANCEL -->
			                <button type="button" class="btn btn-sm btn-danger confirm-delete"
			                        th:data-order-id="${order.orderId}" 
			                        th:data-order-status="${order.orderStatus}">
			                    üóë Delete
			                </button>
			            </div>
			
			            <!-- Hi·ªÉn th·ªã dropdown n·∫øu tr·∫°ng th√°i kh√¥ng ph·∫£i 'CANCEL' -->
			            <div th:if="${order.orderStatus != 'CANCEL'}">
			                <select name="orderStatus" class="form-select form-select-sm" required>
			                    <option value="PENDING" th:selected="${order.orderStatus == 'PENDING'}">Pending</option>
			                    <option value="CANCEL" th:selected="${order.orderStatus == 'CANCEL'}">Cancel</option>
			
			                    <option th:if="${role == 'ROLE_ADMIN'}" value="PROCESSING" th:selected="${order.orderStatus == 'PROCESSING'}">Processing</option>
			                    <option th:if="${role == 'ROLE_ADMIN'}" value="SHIPPED" th:selected="${order.orderStatus == 'SHIPPED'}">Shipped</option>
			                    <option th:if="${role == 'ROLE_ADMIN'}" value="DELIVERED" th:selected="${order.orderStatus == 'DELIVERED'}">Delivered</option>
			                    <option th:if="${role == 'ROLE_ADMIN'}" value="RETURNED" th:selected="${order.orderStatus == 'RETURNED'}">Returned</option>
			                </select>
			                <!-- N√∫t Save khi tr·∫°ng th√°i != CANCEL -->                
			                <button type="submit" class="btn btn-sm btn-success confirm-save">‚úî Save</button>
			            </div>
			        </form>
			    </div>
			</td>
            <!-- T√™n t√†i kho·∫£n c·ªßa ng∆∞·ªùi d√πng -->
            <td th:text="${order.name}"></td>
            <!-- H·ªç t√™n ƒë·∫ßy ƒë·ªß -->
            <td th:text="${order.fullName}"></td>
            <!-- S·ªë ƒëi·ªán tho·∫°i -->
            <td th:text="${order.phoneNumber}"></td>
            <!-- Email -->
            <td th:text="${order.email}"></td>
            <!-- T√™n t·ªânh -->
            <td th:text="${order.provinceName}"></td>
            <!-- T√™n qu·∫≠n  -->
            <td th:text="${order.districtName}"></td>
            <!-- T√™n huy·ªán -->
            <td th:text="${order.wardName}"></td>
            <!-- S·ªë nh√† -->
            <td th:text="${order.address}"></td>       
            <!-- Ph∆∞∆°ng th·ª©c thanh to√°n -->     
            <td th:text="${order.paymentMethod}"></td>
            <!-- Ghi ch√∫ -->
            <td th:text="${order.note}"></td>
            <!-- T·ªïng ti·ªÅn -->
            <td th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' VND'"></td>
            <!-- Chi ti·∫øt ƒë∆°n h√†ng -->
            <td>
                <button class="btn btn-primary btn-sm" data-bs-toggle="collapse" th:data-bs-target="'#details-' + ${order.orderId}">
                    üîç View
                </button>
            </td>
        </tr>

        <tr>
            <td colspan="17" class="p-0 border-0">
                <div th:id="'details-' + ${order.orderId}" class="collapse">
                    <div class="p-3 bg-light">
                        <h6>üìù Order Detail</h6>
                        <table class="table table-sm table-striped mb-0">
                            <thead class="table-secondary">
                                <tr>
                                	<th>Order detail Id</th>                                	
                                    <th>Product name</th>
                                    <th>Quantity</th>
                                    <th>Price</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <th:block th:each="detail : ${allOrderDetail}">
                                    <tr th:if="${detail.orderId == order.orderId}">
                                    	<!-- Id chi ti·∫øt ƒë∆°n h√†ng -->
                                        <td th:text="${detail.ordersDetailId}"></td>                                    	
                                    	<!-- T√™n s·∫£n ph·∫©m -->
                                        <td th:text="${detail.productName}"></td>
                                        <!-- S·ªë l∆∞·ª£ng -->
                                        <td th:text="${detail.amount}"></td>
                                        <!-- Gi√° ti·ªÅn s·∫£n ph·∫©m -->
                                        <td th:text="${#numbers.formatDecimal(detail.unitPrice, 0, 'COMMA', 0, 'POINT')} + ' VND'"></td>
                                        <!-- T·ªïng s·ªë ti·ªÅn s·∫£n ph·∫©m -->
                                        <td th:text="${#numbers.formatDecimal(detail.totalPrice, 0, 'COMMA', 0, 'POINT')} + ' VND'"></td>
                                    </tr>
                                </th:block>
                            </tbody>
                        </table>
                    </div>
                </div>
            </td>
        </tr>
    </th:block>
</table>

<!-- Bootstrap Script -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<!-- SweetAlert Script -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    // B∆∞·ªõc 1: Th√™m s·ª± ki·ªán click cho t·∫•t c·∫£ c√°c n√∫t c√≥ class 'confirm-delete'
    document.querySelectorAll('.confirm-delete').forEach(button => {
        button.addEventListener('click', function () {
            // B∆∞·ªõc 2: L·∫•y orderId v√† orderStatus t·ª´ c√°c thu·ªôc t√≠nh data c·ªßa n√∫t
            const orderId = button.getAttribute('data-order-id');
            const orderStatus = button.getAttribute('data-order-status');

            // B∆∞·ªõc 3: Hi·ªÉn th·ªã SweetAlert ƒë·ªÉ x√°c nh·∫≠n vi·ªác x√≥a ƒë∆°n h√†ng
            Swal.fire({
                title: 'Are you sure to delete it?',
                text: "This will permanently delete the order!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#aaa',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    // B∆∞·ªõc 4: T√¨m form ch·ª©a n√∫t delete
                    const form = button.closest('form');
                    // B∆∞·ªõc 5: C·∫≠p nh·∫≠t action c·ªßa form v·ªõi URL ch·ª©a tham s·ªë orderId v√† orderStatus
                    form.action = '/ComplexGym/payment/deleteOrder?orderId=' + encodeURIComponent(orderId) + '&orderStatus=' + encodeURIComponent(orderStatus);
                    console.log(form.action);  // Ki·ªÉm tra URL ƒë∆∞·ª£c t·∫°o ra
                    form.submit();  // G·ª≠i form sau khi x√°c nh·∫≠n
                }
            });
        });
    });

    // B∆∞·ªõc 6: Th√™m s·ª± ki·ªán submit cho t·∫•t c·∫£ c√°c form c√≥ class 'order-status-form'
    document.querySelectorAll('.order-status-form').forEach(form => {
        form.addEventListener('submit', function (e) {
            e.preventDefault(); // Ng·ª´ng vi·ªác submit form m·∫∑c ƒë·ªãnh

            const button = e.submitter; // L·∫•y n√∫t ƒë∆∞·ª£c nh·∫•n (button nh·∫•n ƒë·ªÉ submit)
            if (button.classList.contains('confirm-save')) {
                // B∆∞·ªõc 7: N·∫øu l√† n√∫t Save, hi·ªÉn th·ªã SweetAlert ƒë·ªÉ x√°c nh·∫≠n
                Swal.fire({
                    title: 'Confirm status change?',
                    text: "Do you want to update the order status?",
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes, update it!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        form.submit();  // G·ª≠i form sau khi x√°c nh·∫≠n
                    }
                });
            }
        });
    });
});
</script>
</body>
</html>
