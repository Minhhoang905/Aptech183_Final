<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            text-align: center;
        }
        .error {
            color: red;
            font-size: 14px;
        }
        .success {
            color: green;
            font-size: 14px;
        }
        .input-container {
            position: relative;
            display: inline-block;
        }
        .toggle-password {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
        }
        #popupContainer {
            display: none;
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }
        #popupContainer button {
            margin-top: 10px;
            padding: 5px 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>

<h2>Reset Password</h2>

<!-- Hi·ªÉn th·ªã l·ªói t·ª´ back-end -->
<p id="errorMessage" class="error" th:text="${errorMessage}" style="display: none;"></p>
<p id="successMessage" class="success" th:text="${successMessage}" style="display: none;"></p>

<!-- Form ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u -->
<form id="resetPasswordForm" th:action="@{/forgot-password/reset}" th:object="${changeNewPass}" method="post">
    <input type="hidden" name="token" th:value="${token}">

    <h3>Username</h3>
    <input type="text" id="name" name="name" placeholder="Enter username" required>
    <p id="nameError" class="error"></p>

    <h3>New password</h3>
    <div class="input-container">
        <input type="password" id="pass" name="pass" placeholder="Enter new password" required>
        <span class="toggle-password" onclick="togglePassword('pass', this)">üôà</span>
    </div>
    <p id="passError" class="error"></p>

    <h3>Confirm password</h3>
    <div class="input-container">
        <input type="password" id="newPass" name="newPass" placeholder="Confirm new password" required>
        <span class="toggle-password" onclick="togglePassword('newPass', this)">üôà</span>
    </div>
    <p id="newPassError" class="error"></p>

    <button type="submit">Reset Password</button>
</form>

<!-- Pop-up th√¥ng b√°o, gi·ªØ trong body ƒë·ªÉ ƒë·∫£m b·∫£o pop-up hi·ªÉn th·ªã -->
<div id="popupContainer">
    <p id="popupMessage"></p>
    <button id="confirmBtn">OK</button>
    <button id="cancelBtn">Cancel</button>   
</div>

<script>
// H√†m chuy·ªÉn ƒë·ªïi hi·ªÉn th·ªã m·∫≠t kh·∫©u (·∫©n/hi·ªán)
function togglePassword(inputId, toggleButton) {
    const passwordInput = document.getElementById(inputId);
    const isPasswordVisible = passwordInput.type === 'password';
    // N·∫øu ƒëang l√† password th√¨ chuy·ªÉn sang text, ng∆∞·ª£c l·∫°i th√¨ chuy·ªÉn l·∫°i password
    passwordInput.type = isPasswordVisible ? 'text' : 'password';
    // Thay ƒë·ªïi icon theo tr·∫°ng th√°i
    toggleButton.textContent = isPasswordVisible ? 'üëÅÔ∏è' : 'üôà';
}

function showPopup(message, onConfirm, showCancel = false) {
    // Hi·ªÉn th·ªã th√¥ng b√°o trong pop-up
    $('#popupMessage').text(message);
    $('#popupContainer').show();

    // Ki·ªÉm tra n·∫øu c·∫ßn hi·ªÉn th·ªã n√∫t "Cancel"
    if (showCancel) {
        $('#cancelBtn').show();
    } else {
        $('#cancelBtn').hide();
    }

    // Khi b·∫•m n√∫t "OK" (X√°c nh·∫≠n)
    $('#confirmBtn').off('click').on('click', function () {
        $('#popupContainer').hide(); // ·∫®n pop-up
        if (onConfirm) onConfirm(); // N·∫øu c√≥ callback th√¨ th·ª±c thi n√≥
    });

    // Khi b·∫•m n√∫t "Cancel" (H·ªßy)
    $('#cancelBtn').off('click').on('click', function () {
        $('#popupContainer').hide(); // Ch·ªâ ƒë∆°n gi·∫£n l√† ·∫©n pop-up
    });
}

$(document).ready(function () {
    // Ki·ªÉm tra n·∫øu c√≥ l·ªói t·ª´ back-end, hi·ªÉn th·ªã pop-up
    let errorMessage = $('#errorMessage').text().trim();
    if (errorMessage) showPopup(errorMessage); // ‚ùå Ch·ªâ hi·ªÉn th·ªã "OK"

    // N·∫øu c√≥ th√¥ng b√°o th√†nh c√¥ng, hi·ªÉn th·ªã pop-up r·ªìi chuy·ªÉn trang
    let successMessage = $('#successMessage').text().trim();
    if (successMessage) {
        showPopup(successMessage, function () {
            window.location.href = "/login"; // Chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang ƒëƒÉng nh·∫≠p sau khi reset th√†nh c√¥ng
        });
    }

    // Ki·ªÉm tra form khi ng∆∞·ªùi d√πng nh·∫•n "Reset Password"
    $('#resetPasswordForm').on('submit', function (event) {
        let isValid = true;
        let username = $('input[name="name"]').val().trim();
        let newPass = $('input[name="pass"]').val().trim();
        let confirmPass = $('input[name="newPass"]').val().trim();
        let errors = [];

        // Ki·ªÉm tra Username
        if (username.length < 5) errors.push("Username must be at least 5 characters.");
        if (!/^[a-zA-Z0-9]+$/.test(username)) errors.push("Username must not contain special characters.");

        // Ki·ªÉm tra M·∫≠t kh·∫©u theo c√°c ti√™u ch√≠ b·∫£o m·∫≠t
        if (newPass.length < 8) errors.push("Password must be at least 8 characters.");
        if (!/[A-Z]/.test(newPass)) errors.push("Must contain at least 1 uppercase letter.");
        if (!/[a-z]/.test(newPass)) errors.push("Must contain at least 1 lowercase letter.");
        if (!/[0-9]/.test(newPass)) errors.push("Must contain at least 1 number.");
        if (!/[@$!%*?&]/.test(newPass)) errors.push("Must contain at least 1 special character (@$!%*?&).");
        if (/[Ôº°-Ôº∫ÔΩÅ-ÔΩöÔºê-Ôºô]/.test(newPass)) errors.push("Password must not contain full-size characters.");

        // N·∫øu c√≥ l·ªói nh·∫≠p li·ªáu, hi·ªÉn th·ªã pop-up ch·ªâ v·ªõi n√∫t "OK"
        if (errors.length > 0) {
            isValid = false;
            showPopup(errors.join('<br>'), null, false); // ‚ùå Ch·ªâ c√≥ "OK"
        }

        // Ki·ªÉm tra x√°c nh·∫≠n m·∫≠t kh·∫©u
        if (newPass !== confirmPass) {
            isValid = false;
            showPopup("Passwords do not match.", null, false); // ‚ùå Ch·ªâ c√≥ "OK"
        }

        // N·∫øu kh√¥ng c√≥ l·ªói, hi·ªÉn th·ªã pop-up x√°c nh·∫≠n tr∆∞·ªõc khi g·ª≠i form
        if (isValid) {
            event.preventDefault(); // NgƒÉn form g·ª≠i ngay l·∫≠p t·ª©c
            showPopup("Are you sure you want to reset your password?", function () {
                $('#resetPasswordForm').off('submit').submit(); // G·ª≠i form sau khi ng∆∞·ªùi d√πng x√°c nh·∫≠n
            }, true); // Hi·ªÉn th·ªã c·∫£ "OK" v√† "Cancel"
        } else {
            event.preventDefault(); // N·∫øu c√≥ l·ªói, kh√¥ng g·ª≠i form
        }
    });
});
</script>

</body>
</html>
